<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netrunner Card Database Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/en.js"></script>
    <script src="https://unpkg.com/acorn/dist/acorn.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .property-key { font-weight: 600; color: #a0aec0; }
        .loader {
            border: 2px solid #f3f3f3; border-top: 2px solid #3498db;
            border-radius: 50%; width: 16px; height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col h-screen">

    <header class="bg-gray-800 shadow-md p-4 flex flex-col sm:flex-row justify-between items-center z-10 gap-4">
        <h1 class="text-2xl font-bold text-cyan-400">Netrunner DB Editor <span class="text-xs text-gray-400">v1.2</span></h1>
        <div class="flex items-center space-x-4">
            <button id="start-new-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg">Start New</button>
            <label for="file-upload" class="cursor-pointer bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded-lg">Load .js File</label>
            <input id="file-upload" type="file" class="hidden" accept=".js">
            <button id="file-settings-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">File Settings</button>
            <button id="download-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Save & Download</button>
        </div>
    </header>

    <div id="ai-tools-bar" class="bg-gray-800/50 p-3 flex flex-col sm:flex-row items-center justify-center gap-3 border-t border-b border-gray-700">
        <label for="ai-prompt" class="font-semibold text-cyan-400">âœ¨ AI Card Generation:</label>
        <input type="text" id="ai-prompt" placeholder="e.g., a sneaky runner event that messes with corp credits" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-gray-200 w-full sm:w-auto">
        <button id="generate-card-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded-lg w-full sm:w-auto">Generate Card</button>
    </div>

    <main class="flex flex-1 overflow-hidden">
        <div id="card-list-container" class="w-1/3 bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-semibold">Cards</h2>
                <button id="add-card-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>+</button>
            </div>
            <div id="card-list" class="overflow-y-auto flex-1 p-2">
                <p class="text-gray-500 text-center p-4">Load a file or start new to see cards.</p>
            </div>
        </div>

        <div id="editor-container" class="w-2/3 bg-gray-900 flex flex-col overflow-hidden">
            <div id="editor-header" class="p-4 border-b border-gray-700 flex justify-between items-center hidden">
                <h2 id="editor-title" class="text-xl font-semibold">Card Details</h2>
                <div>
                    <button id="save-card-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Save Changes</button>
                    <button id="manage-fields-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg ml-2">Manage Fields</button>
                    <button id="delete-card-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg ml-2">Delete Card</button>
                </div>
            </div>
            <div id="editor-content" class="overflow-y-auto flex-1 p-6">
                <div id="welcome-message" class="text-center text-gray-500">
                    <p class="text-lg">Welcome!</p>
                    <p>Load a card file or start a new one to begin editing.</p>
                </div>
            </div>
        </div>
    </main>

    <div id="message-box" class="fixed bottom-5 right-5 bg-gray-700 text-white py-3 px-5 rounded-lg shadow-lg transition-opacity duration-300 opacity-0">
        <p id="message-text"></p>
    </div>

    <div id="fields-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-lg font-semibold">Manage Card Fields</h3><button id="close-modal-btn" class="text-gray-400 hover:text-white">&times;</button></div>
            <div class="p-6 max-h-96 overflow-y-auto"><div id="modal-fields-list" class="space-y-2 mb-4"></div><div class="flex space-x-2"><select id="new-field-select" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-gray-200"></select><button id="add-field-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Add</button></div></div>
            <div class="p-4 bg-gray-800 border-t border-gray-700 flex justify-end"><button id="apply-fields-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Apply Changes</button></div>
        </div>
    </div>

    <div id="file-settings-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold">File Settings</h3>
                <button id="close-file-settings-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="data-var-name" class="block mb-1 font-semibold text-gray-300">Data Variable Name</label>
                    <input type="text" id="data-var-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-gray-200">
                </div>
                <div>
                    <label for="set-identifier-string" class="block mb-1 font-semibold text-gray-300">Set Identifier String</label>
                    <input type="text" id="set-identifier-string" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-gray-200">
                </div>
            </div>
            <div class="p-4 bg-gray-800 border-t border-gray-700 flex justify-end">
                <button id="save-file-settings-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Save Settings</button>
            </div>
        </div>
    </div>

    <div id="block-builder-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-6xl mx-4 flex flex-col" style="height: 85vh;">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="block-builder-title" class="text-lg font-semibold">Logic Builder</h3>
                <div>
                    <button id="apply-code-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Apply Code</button>
                    <button id="close-block-builder-btn" class="text-gray-400 hover:text-white ml-2">&times;</button>
                </div>
            </div>
            <div id="blockly-container" class="flex-1 relative">
                <div id="blockly-div" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;"></div>
            </div>
        </div>
    </div>

    <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
        <category name="Control" colour="%{BKY_LOGIC_HUE}">
            <block type="controls_if"></block>
            <block type="controls_if"><mutation else="1"></mutation></block>
            <block type="controls_if"><mutation elseif="1" else="1"></mutation></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="procedures_ifreturn"></block>
        </category>
        <category name="Checks" colour="210">
            <block type="check_card_type"></block>
            <block type="check_sub_type"></block>
            <block type="check_credits"></block>
            <block type="check_tags"></block>
            <block type="check_encounter"></block>
            <block type="check_running"></block>
            <block type="check_accessing"></block>
            <block type="check_counters"></block>
        </category>
        <category name="Actions" colour="290">
             <block type="make_run"></block>
            <block type="gain_credits"></block>
            <block type="lose_credits"></block>
            <block type="draw_cards"></block>
            <block type="add_tags"></block>
            <block type="sabotage"></block>
            <block type="damage"></block>
            <block type="trash_card"></block>
            <block type="end_run"></block>
            <block type="lose_clicks"></block>
            <block type="gain_clicks"></block>
            <block type="derez"></block>
            <block type="add_counters"></block>
            <block type="remove_counters"></block>
            <block type="break_subroutine"></block>
            <block type="bypass_ice"></block>
            <block type="boost_strength"></block>
            <block type="remove_from_game"></block>
        </category>
        <category name="Values" colour="%{BKY_MATH_HUE}">
            <block type="math_number"><field name="NUM">1</field></block>
            <block type="text"></block>
            <block type="logic_boolean"></block>
            <block type="logic_null"></block>
        </category>
        <category name="Variables" colour="%{BKY_VARIABLES_HUE}" custom="VARIABLE"></category>
        <category name="Game State" colour="160">
            <block type="game_variable_runner"></block>
            <block type="game_variable_corp"></block>
            <block type="game_variable_this"></block>
            <block type="game_variable_accessing_card"></block>
            <block type="game_variable_attacked_server"></block>
            <block type="set_this_property"></block>
        </category>
    </xml>

    <script src="https://cdn.jsdelivr.net/gh/alecdvor/netrunner-db-app@main/netrunner-db-lib.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            NetrunnerDB.cacheDom();
            const dom = NetrunnerDB.dom;

            dom.fileUpload.addEventListener('change', (e) => NetrunnerDB.handleFileUpload(e));
            dom.startNewBtn.addEventListener('click', () => NetrunnerDB.handleStartNewFile());
            dom.downloadBtn.addEventListener('click', () => NetrunnerDB.handleFileDownload());
            dom.addCardBtn.addEventListener('click', () => NetrunnerDB.handleAddCard());
            dom.saveCardBtn.addEventListener('click', () => NetrunnerDB.handleSaveChanges());
            dom.deleteCardBtn.addEventListener('click', () => NetrunnerDB.handleDeleteCard());
            dom.manageFieldsBtn.addEventListener('click', () => NetrunnerDB.openManageFieldsModal());
            dom.closeModalBtn.addEventListener('click', () => dom.fieldsModal.classList.add('hidden'));
            dom.fieldsModal.addEventListener('click', (e) => { if (e.target === dom.fieldsModal) dom.fieldsModal.classList.add('hidden'); });
            dom.addFieldBtn.addEventListener('click', () => NetrunnerDB.handleAddFieldToModal());
            dom.applyFieldsBtn.addEventListener('click', () => NetrunnerDB.handleApplyFieldChanges());
            dom.fileSettingsBtn.addEventListener('click', () => NetrunnerDB.openFileSettingsModal());
            dom.closeFileSettingsBtn.addEventListener('click', () => dom.fileSettingsModal.classList.add('hidden'));
            dom.fileSettingsModal.addEventListener('click', (e) => { if (e.target === dom.fileSettingsModal) dom.fileSettingsModal.classList.add('hidden'); });
            dom.saveFileSettingsBtn.addEventListener('click', () => NetrunnerDB.saveFileSettings());

            const blockBuilderModal = document.getElementById('block-builder-modal');
            const closeBlockBuilderBtn = document.getElementById('close-block-builder-btn');
            const applyCodeBtn = document.getElementById('apply-code-btn');
            const blocklyDiv = document.getElementById('blockly-div');
            const toolbox = document.getElementById('toolbox');
            let blocklyWorkspace;
            
            const blockMappings = {};

            initializeCustomBlocks();

            closeBlockBuilderBtn.addEventListener('click', () => {
                blockBuilderModal.classList.add('hidden');
                disposeBlockly();
            });
            
            applyCodeBtn.addEventListener('click', () => {
                applyGeneratedCode();
                blockBuilderModal.classList.add('hidden');
                disposeBlockly();
            });
            
            NetrunnerDB.openBlockBuilder = function() {
                const fieldKey = NetrunnerDB.currentlyBuildingField;
                const targetInput = dom.editorContent.querySelector(`[name="${fieldKey}"]`);
                let existingCode = '';
                if (targetInput && targetInput.value) {
                    try {
                        const funcRegex = /(Resolve|Enumerate):\s*function\s*\([^)]*\)\s*\{([\s\S]*)\}/;
                        const match = funcRegex.exec(targetInput.value);
                        if (match && match[2]) {
                            existingCode = match[2].trim();
                        }
                    } catch(e) { console.error("Could not parse existing code.", e); }
                }
                blockBuilderModal.classList.remove('hidden');
                initializeBlockly(existingCode);
            }
            
            function applyGeneratedCode() {
                const code = Blockly.JavaScript.workspaceToCode(blocklyWorkspace);
                const fieldKey = NetrunnerDB.currentlyBuildingField;
                const targetInput = dom.editorContent.querySelector(`[name="${fieldKey}"]`);

                if (targetInput) {
                    const functionWrapper = `{ Resolve: function(card) {\n${code}\n} }`;
                    try {
                        const codeObject = new Function(`return ${functionWrapper}`)();
                        targetInput.value = NetrunnerDB.objectToString(codeObject, 2);
                        NetrunnerDB.showMessage('Code applied from builder!', 'success');
                    } catch (e) {
                         console.error("Error creating function from Blockly code:", e);
                         NetrunnerDB.showMessage('Could not apply code. Invalid logic.', 'error');
                    }
                }
            }
            
            function initializeBlockly(codeToLoad = '') {
                console.log("Initializing Blockly with code:", codeToLoad);
                if (blocklyDiv.offsetHeight > 0) {
                    blocklyWorkspace = Blockly.inject(blocklyDiv, {
                        toolbox: toolbox,
                        renderer: 'zelos',
                        theme: Blockly.Themes.Dark,
                        grid: { spacing: 20, length: 3, colour: '#4a5568', snap: true },
                        zoom: { controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 }
                    });

                    if (codeToLoad) {
                        try {
                            const ast = acorn.parse(codeToLoad, {ecmaVersion: 2020});
                            buildBlocksFromAst(ast.body);
                            blocklyWorkspace.render();
                        } catch (e) {
                            console.error("Failed to convert code to blocks:", e);
                            NetrunnerDB.showMessage("Could not load existing code into blocks.", "error");
                        }
                    }
                } else {
                    setTimeout(() => initializeBlockly(codeToLoad), 10);
                }
            }
            
            function disposeBlockly() {
                if (blocklyWorkspace) {
                    blocklyWorkspace.dispose();
                    blocklyWorkspace = null;
                }
            }
            
            function buildBlocksFromAst(statements) {
                let lastBlock = null;
                statements.forEach(stmt => {
                    const newBlock = processStatement(stmt);
                    if (newBlock) {
                        if (lastBlock && lastBlock.nextConnection) {
                            lastBlock.nextConnection.connect(newBlock.previousConnection);
                        }
                        lastBlock = newBlock;
                    }
                });
            }

            function processStatement(stmt) {
                if (!stmt) return null;
                switch(stmt.type) {
                    case 'ExpressionStatement': return processExpression(stmt.expression);
                    case 'IfStatement': return processIfStatement(stmt);
                    case 'VariableDeclaration': return processVariableDeclaration(stmt);
                    case 'ReturnStatement': return processReturnStatement(stmt);
                    default: console.warn("Unsupported statement type:", stmt.type); return null;
                }
            }

             function processExpression(expr) {
                switch(expr.type) {
                    case 'CallExpression':
                        const block = createBlockFromCall(expr);
                        if (block) block.initSvg();
                        return block;
                    case 'AssignmentExpression':
                        return processAssignment(expr);
                    default:
                        console.warn("Unsupported expression type:", expr.type);
                        return null;
                }
            }

             function processAssignment(expr) {
                if (expr.left.type === 'MemberExpression' && expr.left.object.type === 'ThisExpression') {
                    const propName = expr.left.property.name;
                    const valueBlock = createValueBlock(expr.right);
                    const setBlock = blocklyWorkspace.newBlock('set_this_property');
                    setBlock.setFieldValue(propName, 'PROPERTY');
                    if (valueBlock) {
                        setBlock.getInput('VALUE').connection.connect(valueBlock.outputConnection);
                    }
                    setBlock.initSvg();
                    return setBlock;
                }
                return null;
            }


            function processIfStatement(stmt) {
                const ifBlock = blocklyWorkspace.newBlock('controls_if');
                
                const conditionBlock = processExpression(stmt.test);
                if (conditionBlock) {
                    ifBlock.getInput('IF0').connection.connect(conditionBlock.outputConnection);
                }
                
                let lastBlockInIf = null;
                if (stmt.consequent && stmt.consequent.body) {
                    stmt.consequent.body.forEach(s => {
                        const newBlock = processStatement(s);
                        if (newBlock) {
                           if (!lastBlockInIf) {
                               ifBlock.getInput('DO0').connection.connect(newBlock.previousConnection);
                           } else {
                               lastBlockInIf.nextConnection.connect(newBlock.previousConnection);
                           }
                           lastBlockInIf = newBlock;
                        }
                    });
                }
                
                if (stmt.alternate) {
                    ifBlock.appendStatementInput('ELSE').appendField('else');
                     let lastBlockInElse = null;
                    if (stmt.alternate.body) {
                        stmt.alternate.body.forEach(s => {
                             const newBlock = processStatement(s);
                             if (newBlock) {
                                if(!lastBlockInElse) {
                                    ifBlock.getInput('ELSE').connection.connect(newBlock.previousConnection);
                                } else {
                                    lastBlockInElse.nextConnection.connect(newBlock.previousConnection);
                                }
                                lastBlockInElse = newBlock;
                             }
                        });
                    }
                }
                
                ifBlock.initSvg();
                return ifBlock;
            }
             
            function processVariableDeclaration(stmt) {
                const declaration = stmt.declarations[0];
                const varName = declaration.id.name;
                const valueBlock = createValueBlock(declaration.init);
                
                const setBlock = blocklyWorkspace.newBlock('variables_set');
                setBlock.setFieldValue(varName, 'VAR');
                if (valueBlock) {
                    setBlock.getInput('VALUE').connection.connect(valueBlock.outputConnection);
                }
                setBlock.initSvg();
                return setBlock;
            }
            
            function processReturnStatement(stmt) {
                 const returnBlock = blocklyWorkspace.newBlock('procedures_ifreturn');
                 const valueBlock = createValueBlock(stmt.argument);
                 if (valueBlock) {
                    returnBlock.getInput('VALUE').connection.connect(valueBlock.outputConnection);
                 }
                 returnBlock.initSvg();
                 return returnBlock;
            }

            function createValueBlock(node) {
                if (!node) return null;
                 switch(node.type) {
                    case 'Literal':
                        const type = typeof node.value;
                        let blockType;
                        if (type === 'number') blockType = 'math_number';
                        else if (type === 'string') blockType = 'text';
                        else if (type === 'boolean') blockType = 'logic_boolean';
                        else return null;

                        const block = blocklyWorkspace.newBlock(blockType);
                        const fieldName = (blockType === 'logic_boolean') ? 'BOOL' : (blockType === 'text' ? 'TEXT' : 'NUM');
                        block.setFieldValue(node.value.toString(), fieldName);
                        block.initSvg();
                        return block;
                    case 'Identifier':
                         const varBlock = blocklyWorkspace.newBlock('variables_get');
                         varBlock.setFieldValue(node.name, 'VAR');
                         varBlock.initSvg();
                         return varBlock;
                    case 'CallExpression':
                        return createBlockFromCall(node);
                    default:
                        return null;
                 }
            }

            function createBlockFromCall(expr) {
                const funcName = expr.callee.name;
                const mapping = blockMappings[funcName];
                if (!mapping) return null;

                const newBlock = blocklyWorkspace.newBlock(mapping.type);
                expr.arguments.forEach((arg, i) => {
                    const inputName = mapping.args[i];
                    if (arg.type === 'MemberExpression') {
                         const memberBlock = blocklyWorkspace.newBlock('game_variable_corp');
                         memberBlock.setFieldValue(arg.property.name, 'SERVER');
                         newBlock.getInput(inputName).connection.connect(memberBlock.outputConnection);
                    } else {
                        const valueBlock = createValueBlock(arg);
                        if (valueBlock) {
                            newBlock.getInput(inputName).connection.connect(valueBlock.outputConnection);
                        }
                    }
                });
                return newBlock;
            }
            
            function initializeCustomBlocks() {
                const definitions = [
                    { "type": "check_card_type", "message0": "Card type is %1", "args0": [{"type": "input_value", "name": "TYPE", "check": "String"}], "output": "Boolean", "colour": 210 },
                    { "type": "check_sub_type", "message0": "Card subtype is %1", "args0": [{"type": "input_value", "name": "SUBTYPE", "check": "String"}], "output": "Boolean", "colour": 210 },
                    { "type": "check_credits", "message0": "%1 has at least %2 credits", "args0": [{"type": "input_value", "name": "PLAYER"}, {"type": "input_value", "name": "AMOUNT", "check": "Number"}], "output": "Boolean", "colour": 210 },
                    { "type": "check_tags", "message0": "Runner has at least %1 tags", "args0": [{"type": "input_value", "name": "AMOUNT", "check": "Number"}], "output": "Boolean", "colour": 210 },
                    { "type": "check_encounter", "message0": "is encountering ice", "output": "Boolean", "colour": 210 },
                    { "type": "check_running", "message0": "is running", "output": "Boolean", "colour": 210 },
                    { "type": "check_accessing", "message0": "is accessing", "output": "Boolean", "colour": 210 },
                    { "type": "check_counters", "message0": "card %1 has at least %2 %3 counters", "args0": [{"type": "input_value", "name": "CARD"}, {"type": "input_value", "name": "AMOUNT", "check": "Number"}, {"type": "field_input", "name": "TYPE", "text": "virus"}], "output": "Boolean", "colour": 210 },
                    { "type": "make_run", "message0": "Make a run on %1", "args0": [{"type": "input_value", "name": "SERVER"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "gain_credits", "message0": "%1 gains %2 credits", "args0": [{"type": "input_value", "name": "PLAYER"},{"type": "input_value", "name": "AMOUNT", "check": "Number"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "lose_credits", "message0": "%1 loses %2 credits", "args0": [{"type": "input_value", "name": "PLAYER"},{"type": "input_value", "name": "AMOUNT", "check": "Number"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "draw_cards", "message0": "%1 draws %2 cards", "args0": [{"type": "input_value", "name": "PLAYER"},{"type": "input_value", "name": "AMOUNT", "check": "Number"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "add_tags", "message0": "Runner gains %1 tags", "args0": [{"type": "input_value", "name": "AMOUNT", "check": "Number"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "sabotage", "message0": "Sabotage %1", "args0": [{"type": "input_value", "name": "AMOUNT", "check": "Number"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "damage", "message0": "Do %1 %2 damage", "args0": [{"type": "input_value", "name": "AMOUNT", "check": "Number"}, {"type": "field_dropdown", "name": "TYPE", "options": [["net","net"],["meat","meat"],["core","core"]]}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "trash_card", "message0": "Trash %1", "args0": [{"type": "input_value", "name": "CARD"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "end_run", "message0": "End the run", "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "lose_clicks", "message0": "%1 loses %2 clicks", "args0": [{"type": "input_value", "name": "PLAYER"},{"type": "input_value", "name": "AMOUNT", "check": "Number"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "gain_clicks", "message0": "%1 gains %2 clicks", "args0": [{"type": "input_value", "name": "PLAYER"},{"type": "input_value", "name": "AMOUNT", "check": "Number"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "derez", "message0": "Derez %1", "args0": [{"type": "input_value", "name": "CARD"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "add_counters", "message0": "Add %1 %2 counters to %3", "args0": [{"type": "input_value", "name": "AMOUNT", "check": "Number"}, {"type": "field_input", "name": "TYPE", "text": "virus"}, {"type": "input_value", "name": "CARD"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "remove_counters", "message0": "Remove %1 %2 counters from %3", "args0": [{"type": "input_value", "name": "AMOUNT", "check": "Number"}, {"type": "field_input", "name": "TYPE", "text": "virus"}, {"type": "input_value", "name": "CARD"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "break_subroutine", "message0": "Break subroutine %1", "args0": [{"type": "input_value", "name": "SUBROUTINE"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "bypass_ice", "message0": "Bypass ice", "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "boost_strength", "message0": "Boost strength of %1 by %2", "args0": [{"type": "input_value", "name": "CARD"}, {"type": "input_value", "name": "AMOUNT", "check": "Number"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "remove_from_game", "message0": "Remove %1 from the game", "args0": [{"type": "input_value", "name": "CARD"}], "previousStatement": null, "nextStatement": null, "colour": 290 },
                    { "type": "game_variable_runner", "message0": "runner", "output": null, "colour": 160 },
                    { "type": "game_variable_corp", "message0": "corp . %1", "args0": [{"type": "field_dropdown", "name": "SERVER", "options": [["HQ","HQ"],["R&D","RnD"],["Archives","archives"]]}], "output": null, "colour": 160 },
                    { "type": "game_variable_this", "message0": "this card", "output": null, "colour": 160 },
                    { "type": "game_variable_accessing_card", "message0": "accessing card", "output": null, "colour": 160 },
                    { "type": "game_variable_attacked_server", "message0": "attacked server", "output": null, "colour": 160 },
                    { "type": "set_this_property", "message0": "set this . %1 to %2", "args0": [{"type": "field_input", "name": "PROPERTY", "text": "property"}, {"type": "input_value", "name": "VALUE"}], "previousStatement": null, "nextStatement": null, "colour": 160 }
                ];
                Blockly.defineBlocksWithJsonArray(definitions);
                const js = Blockly.JavaScript;
                 Object.assign(blockMappings, {
                    'CheckCardType': { type: 'check_card_type', args: ['CARD', 'TYPE'] },
                    'CheckSubType': { type: 'check_sub_type', args: ['CARD', 'SUBTYPE'] },
                    'CheckCredits': { type: 'check_credits', args: ['PLAYER', 'AMOUNT'] },
                    'CheckTags': { type: 'check_tags', args: ['AMOUNT'] },
                    'CheckEncounter': { type: 'check_encounter', args: [] },
                    'CheckRunning': { type: 'check_running', args: [] },
                    'CheckAccessing': { type: 'check_accessing', args: [] },
                    'CheckCounters': { type: 'check_counters', args: ['CARD', 'AMOUNT', 'TYPE'] },
                    'MakeRun': { type: 'make_run', args: ['SERVER'] },
                    'GainCredits': { type: 'gain_credits', args: ['PLAYER', 'AMOUNT'] },
                    'LoseCredits': { type: 'lose_credits', args: ['PLAYER', 'AMOUNT'] },
                    'Draw': { type: 'draw_cards', args: ['PLAYER', 'AMOUNT'] },
                    'AddTags': { type: 'add_tags', args: ['AMOUNT'] },
                    'Sabotage': { type: 'sabotage', args: ['AMOUNT'] },
                    'Damage': { type: 'damage', args: ['TYPE', 'AMOUNT'] },
                    'Trash': { type: 'trash_card', args: ['CARD'] },
                    'EndTheRun': { type: 'end_run', args: [] },
                    'LoseClicks': { type: 'lose_clicks', args: ['PLAYER', 'AMOUNT'] },
                    'GainClicks': { type: 'gain_clicks', args: ['PLAYER', 'AMOUNT'] },
                    'Derez': { type: 'derez', args: ['CARD'] },
                    'AddCounters': { type: 'add_counters', args: ['CARD', 'TYPE', 'AMOUNT'] },
                    'RemoveCounters': { type: 'remove_counters', args: ['CARD', 'TYPE', 'AMOUNT'] },
                    'Break': { type: 'break_subroutine', args: ['SUBROUTINE'] },
                    'Bypass': { type: 'bypass_ice', args: [] },
                    'BoostStrength': { type: 'boost_strength', args: ['CARD', 'AMOUNT'] },
                    'RemoveFromGame': { type: 'remove_from_game', args: ['CARD'] }
                });
                for(const key in blockMappings) {
                    js.forBlock[blockMappings[key].type] = block => {
                        const mapping = blockMappings[key];
                        const args = mapping.args.map(arg => {
                            let val = js.valueToCode(block, arg, js.ORDER_ATOMIC);
                            if (!val) {
                                val = `'${block.getFieldValue(arg)}'`;
                            }
                            return val;
                        }).join(', ');

                        if (block.outputConnection) {
                            return [`${key}(${args})`, js.ORDER_FUNCTION_CALL];
                        }
                        return `${key}(${args});\n`;
                    };
                }
            }
        });
    </script>
</body> 
</html>
